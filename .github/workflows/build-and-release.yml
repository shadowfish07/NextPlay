name: Build and Release

permissions:
  contents: write
  issues: write
  pull-requests: write

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

env:
  FLUTTER_VERSION: "3.35.1"
  JAVA_VERSION: "17"
  NODE_VERSION: "20"

jobs:
  analyze:
    name: Analyze Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: Analyze code
        run: flutter analyze

      # - name: Run tests
      #   run: flutter test

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: analyze
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    outputs:
      version: ${{ steps.version.outputs.version }}
      build-number: ${{ steps.version.outputs.build-number }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
            .dart_tool
          key: ${{ runner.os }}-deps-${{ hashFiles('**/pubspec.lock', '**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: Calculate version
        id: version
        run: |
          # è·å–å½“å‰æœ€æ–°çš„æ ‡ç­¾ç‰ˆæœ¬
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"

          # æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰vå‰ç¼€ï¼‰
          CURRENT_VERSION=${LATEST_TAG#v}
          echo "Current version: $CURRENT_VERSION"

          # è®¡ç®—æ„å»ºå·ï¼ˆåŸºäºæäº¤æ•°ï¼‰
          BUILD_NUMBER=$(git rev-list --count HEAD)
          echo "Build number: $BUILD_NUMBER"

          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨æŒ‡å®šçš„ç‰ˆæœ¬ç±»å‹
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          else
            # è‡ªåŠ¨åˆ¤æ–­ç‰ˆæœ¬ç±»å‹ï¼ˆåŸºäºæäº¤ä¿¡æ¯ï¼‰
            COMMIT_MSG=$(git log -1 --pretty=%B)
            if [[ $COMMIT_MSG =~ ^feat(\(.+\))?!: ]] || [[ $COMMIT_MSG =~ BREAKING.CHANGE ]]; then
              RELEASE_TYPE="major"
            elif [[ $COMMIT_MSG =~ ^feat(\(.+\))?: ]]; then
              RELEASE_TYPE="minor"
            else
              RELEASE_TYPE="patch"
            fi
          fi

          echo "Release type: $RELEASE_TYPE"

          # è®¡ç®—æ–°ç‰ˆæœ¬å·
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}

          case $RELEASE_TYPE in
            "major")
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            "minor")
              NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
              ;;
            "patch")
              NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
              ;;
          esac

          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "build-number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      - name: Update version in pubspec.yaml
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUILD_NUMBER="${{ steps.version.outputs.build-number }}"

          # æ›´æ–° pubspec.yaml ä¸­çš„ç‰ˆæœ¬
          sed -i "s/^version: .*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml

          echo "Updated pubspec.yaml version to: $VERSION+$BUILD_NUMBER"

      - name: Setup Android signing
        run: |
          # åˆ›å»ºç­¾åé…ç½®
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/release-key.jks

          # åˆ›å»º key.properties æ–‡ä»¶
          cat > key.properties << EOF
          storeFile=android/app/release-key.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF

          echo "Android signing configured"

      - name: Build signed APK
        run: |
          flutter build apk --release \
            --build-name="${{ steps.version.outputs.version }}" \
            --build-number="${{ steps.version.outputs.build-number }}"

      - name: Build signed App Bundle
        run: |
          flutter build appbundle --release \
            --build-name="${{ steps.version.outputs.version }}" \
            --build-number="${{ steps.version.outputs.build-number }}"

      - name: Prepare release artifacts
        run: |
          mkdir -p release-artifacts
          VERSION="${{ steps.version.outputs.version }}"

          # å¤åˆ¶æ„å»ºäº§ç‰©
          cp build/app/outputs/flutter-apk/app-release.apk "release-artifacts/nextplay-v${VERSION}.apk"
          cp build/app/outputs/bundle/release/app-release.aab "release-artifacts/nextplay-v${VERSION}.aab"

          # ç”Ÿæˆæ ¡éªŒå’Œ
          cd release-artifacts
          sha256sum *.apk *.aab > checksums.txt

          echo "Release artifacts prepared:"
          ls -la

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-${{ steps.version.outputs.version }}
          path: release-artifacts/
          retention-days: 30

      - name: Clean up signing files
        if: always()
        run: |
          rm -f android/app/release-key.jks
          rm -f key.properties

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-release-${{ needs.build-android.outputs.version }}
          path: release-artifacts/

      - name: Create git tag
        run: |
          VERSION="v${{ needs.build-android.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists, skipping tag creation"
          else
            git tag -a "$VERSION" -m "Release $VERSION"
            git push origin "$VERSION"
            echo "Created and pushed tag: $VERSION"
          fi

      - name: Generate release notes
        id: release-notes
        run: |
          VERSION="v${{ needs.build-android.outputs.version }}"

          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          cat > release-notes.md << EOF
          # NextPlay $VERSION

          ## ğŸ“± ä¸‹è½½

          - **APK (æ¨è)**: [nextplay-${{ needs.build-android.outputs.version }}.apk](https://github.com/${{ github.repository }}/releases/download/$VERSION/nextplay-v${{ needs.build-android.outputs.version }}.apk)
          - **AAB (Google Play)**: [nextplay-${{ needs.build-android.outputs.version }}.aab](https://github.com/${{ github.repository }}/releases/download/$VERSION/nextplay-v${{ needs.build-android.outputs.version }}.aab)

          ## ğŸ“‹ æ›´æ–°å†…å®¹

          EOF

          # æ·»åŠ æäº¤æ—¥å¿—
          if [[ -n "$PREV_TAG" ]]; then
            echo "### ğŸ”„ å˜æ›´è®°å½•" >> release-notes.md
            git log --pretty=format:"- %s (%h)" ${PREV_TAG}..HEAD >> release-notes.md
          else
            echo "### ğŸ‰ é¦–ä¸ªç‰ˆæœ¬" >> release-notes.md
            echo "- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ" >> release-notes.md
          fi

          echo "" >> release-notes.md
          echo "## ğŸ” æ ¡éªŒå’Œ" >> release-notes.md
          echo "\`\`\`" >> release-notes.md
          cat release-artifacts/checksums.txt >> release-notes.md
          echo "\`\`\`" >> release-notes.md

          # è¾“å‡ºå‘å¸ƒè¯´æ˜å†…å®¹
          cat release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.build-android.outputs.version }}
          name: NextPlay v${{ needs.build-android.outputs.version }}
          body_path: release-notes.md
          files: |
            release-artifacts/*.apk
            release-artifacts/*.aab
            release-artifacts/checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notification:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [build-android, release]
    if: always() && (needs.build-android.result == 'success' || needs.build-android.result == 'failure')

    steps:
      - name: Send build notification
        run: |
          if [[ "${{ needs.build-android.result }}" == "success" ]]; then
            echo "âœ… Build completed successfully for version ${{ needs.build-android.outputs.version }}"
            if [[ "${{ needs.release.result }}" == "success" ]]; then
              echo "ğŸš€ Release v${{ needs.build-android.outputs.version }} has been published"
            fi
          else
            echo "âŒ Build failed"
          fi
